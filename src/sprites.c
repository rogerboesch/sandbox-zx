/*
 * Dark Nebula - ZX Spectrum Next Prototype
 * sprites.c - Sprite handling and Layer 2 graphics
 */

#include <arch/zxn.h>
#include <z80.h>
#include <intrinsic.h>
#include <stdint.h>
#include "game.h"

// ZX Spectrum Next I/O ports
#define LAYER2_ACCESS_PORT    0x123B
#define SPRITE_SLOT_PORT      0x303B
#define SPRITE_ATTR_PORT      0x57
#define SPRITE_PATTERN_PORT   0x5B

// Next register values (using literal values to avoid conflicts with z88dk)
#define NEXTREG_SPRITE_SYSTEM  0x15
#define NEXTREG_LAYER2_CTRL    0x70

// 16x16 sprite patterns (256 bytes each, 4-bit per pixel)
// Player ship - facing upward for vertical scroller
static const uint8_t sprite_player[256] = {
    0x00,0x00,0x00,0x0F,0xF0,0x00,0x00,0x00,  // Row 0 - nose
    0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,
    0x00,0x00,0x0F,0xFF,0xFF,0xF0,0x00,0x00,
    0x00,0x00,0x0F,0xFB,0xBF,0xF0,0x00,0x00,
    0x00,0x00,0xFF,0xFB,0xBF,0xFF,0x00,0x00,
    0x00,0x00,0xFF,0xFF,0xFF,0xFF,0x00,0x00,
    0x00,0x0F,0xFF,0xFF,0xFF,0xFF,0xF0,0x00,
    0x00,0x0F,0xFF,0xFF,0xFF,0xFF,0xF0,0x00,
    0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,
    0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,
    0x0F,0xFF,0x0F,0xFF,0xFF,0xF0,0xFF,0xF0,
    0x0F,0xF0,0x0F,0xFF,0xFF,0xF0,0x0F,0xF0,
    0xFF,0xF0,0x00,0xFF,0xFF,0x00,0x0F,0xFF,  // Wings
    0xFF,0x00,0x00,0xFF,0xFF,0x00,0x00,0xFF,
    0xF0,0x00,0x00,0x0F,0xF0,0x00,0x00,0x0F,
    0x00,0x00,0x00,0x0F,0xF0,0x00,0x00,0x00   // Engine
};

// Bullet - vertical energy bolt (fires upward)
static const uint8_t sprite_bullet[256] = {
    0x00,0x00,0x00,0x0E,0xE0,0x00,0x00,0x00,
    0x00,0x00,0x00,0xEF,0xFE,0x00,0x00,0x00,
    0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,
    0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,
    0x00,0x00,0x00,0xEF,0xFE,0x00,0x00,0x00,
    0x00,0x00,0x00,0xEF,0xFE,0x00,0x00,0x00,
    0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,
    0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,
    0x00,0x00,0x00,0xEF,0xFE,0x00,0x00,0x00,
    0x00,0x00,0x00,0x0E,0xE0,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

// Enemy type 1 - alien fighter
static const uint8_t sprite_enemy1[256] = {
    0x00,0x00,0x00,0x0C,0xC0,0x00,0x00,0x00,
    0x00,0x00,0x00,0xCC,0xCC,0x00,0x00,0x00,
    0x00,0x00,0x0C,0xCC,0xCC,0xC0,0x00,0x00,
    0x00,0x00,0xCC,0xC4,0x4C,0xCC,0x00,0x00,
    0x00,0x0C,0xCC,0x44,0x44,0xCC,0xC0,0x00,
    0x00,0xCC,0xCC,0xCC,0xCC,0xCC,0xCC,0x00,
    0x0C,0xCC,0xCC,0xCC,0xCC,0xCC,0xCC,0xC0,
    0xCC,0xCC,0xCC,0xCC,0xCC,0xCC,0xCC,0xCC,
    0xCC,0xCC,0xCC,0xCC,0xCC,0xCC,0xCC,0xCC,
    0x0C,0xCC,0xCC,0xCC,0xCC,0xCC,0xCC,0xC0,
    0x00,0xCC,0xCC,0xCC,0xCC,0xCC,0xCC,0x00,
    0x00,0x0C,0xCC,0x44,0x44,0xCC,0xC0,0x00,
    0x00,0x00,0xCC,0xC4,0x4C,0xCC,0x00,0x00,
    0x00,0x00,0x0C,0xCC,0xCC,0xC0,0x00,0x00,
    0x00,0x00,0x00,0xCC,0xCC,0x00,0x00,0x00,
    0x00,0x00,0x00,0x0C,0xC0,0x00,0x00,0x00
};

// Enemy type 2 - larger cruiser
static const uint8_t sprite_enemy2[256] = {
    0x00,0x00,0x02,0x22,0x22,0x20,0x00,0x00,
    0x00,0x00,0x22,0x22,0x22,0x22,0x00,0x00,
    0x00,0x02,0x22,0x22,0x22,0x22,0x20,0x00,
    0x00,0x22,0x22,0x2E,0xE2,0x22,0x22,0x00,
    0x02,0x22,0x22,0xEE,0xEE,0x22,0x22,0x20,
    0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,
    0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,
    0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,
    0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,
    0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,
    0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,
    0x02,0x22,0x22,0xEE,0xEE,0x22,0x22,0x20,
    0x00,0x22,0x22,0x2E,0xE2,0x22,0x22,0x00,
    0x00,0x02,0x22,0x22,0x22,0x22,0x20,0x00,
    0x00,0x00,0x22,0x22,0x22,0x22,0x00,0x00,
    0x00,0x00,0x02,0x22,0x22,0x20,0x00,0x00
};

// Explosion animation frame
static const uint8_t sprite_explosion[256] = {
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x0E,0x00,0x00,0xE0,0x00,0x00,
    0x00,0x00,0xE0,0xE0,0x0E,0x0E,0x00,0x00,
    0x00,0x0E,0x00,0xEE,0xEE,0x00,0xE0,0x00,
    0x00,0xE0,0x0E,0xFF,0xFF,0xE0,0x0E,0x00,
    0x00,0x00,0xEF,0xFF,0xFF,0xFE,0x00,0x00,
    0x00,0xE0,0xFF,0xFF,0xFF,0xFF,0x0E,0x00,
    0x0E,0x0E,0xFF,0xFF,0xFF,0xFF,0xE0,0xE0,
    0x0E,0x0E,0xFF,0xFF,0xFF,0xFF,0xE0,0xE0,
    0x00,0xE0,0xFF,0xFF,0xFF,0xFF,0x0E,0x00,
    0x00,0x00,0xEF,0xFF,0xFF,0xFE,0x00,0x00,
    0x00,0xE0,0x0E,0xFF,0xFF,0xE0,0x0E,0x00,
    0x00,0x0E,0x00,0xEE,0xEE,0x00,0xE0,0x00,
    0x00,0x00,0xE0,0xE0,0x0E,0x0E,0x00,0x00,
    0x00,0x00,0x0E,0x00,0x00,0xE0,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

// Highway tile - cyan fill with white border on left and top
static const uint8_t sprite_highway[256] = {
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,  // Row 0 - all white (top border)
    0xF7,0x77,0x77,0x77,0x77,0x77,0x77,0x77,  // Row 1 - white left, cyan rest
    0xF7,0x77,0x77,0x77,0x77,0x77,0x77,0x77,
    0xF7,0x77,0x77,0x77,0x77,0x77,0x77,0x77,
    0xF7,0x77,0x77,0x77,0x77,0x77,0x77,0x77,
    0xF7,0x77,0x77,0x77,0x77,0x77,0x77,0x77,
    0xF7,0x77,0x77,0x77,0x77,0x77,0x77,0x77,
    0xF7,0x77,0x77,0x77,0x77,0x77,0x77,0x77,
    0xF7,0x77,0x77,0x77,0x77,0x77,0x77,0x77,
    0xF7,0x77,0x77,0x77,0x77,0x77,0x77,0x77,
    0xF7,0x77,0x77,0x77,0x77,0x77,0x77,0x77,
    0xF7,0x77,0x77,0x77,0x77,0x77,0x77,0x77,
    0xF7,0x77,0x77,0x77,0x77,0x77,0x77,0x77,
    0xF7,0x77,0x77,0x77,0x77,0x77,0x77,0x77,
    0xF7,0x77,0x77,0x77,0x77,0x77,0x77,0x77,
    0xF7,0x77,0x77,0x77,0x77,0x77,0x77,0x77   // Row 15
};

// Life indicator - small ship icon (8x8 centered in 16x16)
static const uint8_t sprite_life[256] = {
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x0F,0xF0,0x00,0x00,0x00,  // Row 4
    0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,
    0x00,0x00,0x0F,0xFF,0xFF,0xF0,0x00,0x00,
    0x00,0x00,0xFF,0xFF,0xFF,0xFF,0x00,0x00,
    0x00,0x0F,0x0F,0xFF,0xFF,0xF0,0xF0,0x00,
    0x00,0xF0,0x00,0xFF,0xFF,0x00,0x0F,0x00,
    0x00,0x00,0x00,0x0F,0xF0,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

// Digit sprites for score display (8x8 centered in 16x16, digits 0-9)
static const uint8_t sprite_digits[10][256] = {
    // Digit 0
    {
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,
        0x00,0x00,0x0F,0xF0,0x0F,0xF0,0x00,0x00,
        0x00,0x00,0x0F,0xF0,0x0F,0xF0,0x00,0x00,
        0x00,0x00,0x0F,0xF0,0x0F,0xF0,0x00,0x00,
        0x00,0x00,0x0F,0xF0,0x0F,0xF0,0x00,0x00,
        0x00,0x00,0x0F,0xF0,0x0F,0xF0,0x00,0x00,
        0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },
    // Digit 1
    {
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x0F,0xF0,0x00,0x00,0x00,
        0x00,0x00,0x00,0xFF,0xF0,0x00,0x00,0x00,
        0x00,0x00,0x00,0x0F,0xF0,0x00,0x00,0x00,
        0x00,0x00,0x00,0x0F,0xF0,0x00,0x00,0x00,
        0x00,0x00,0x00,0x0F,0xF0,0x00,0x00,0x00,
        0x00,0x00,0x00,0x0F,0xF0,0x00,0x00,0x00,
        0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },
    // Digit 2
    {
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,
        0x00,0x00,0x0F,0xF0,0x0F,0xF0,0x00,0x00,
        0x00,0x00,0x00,0x00,0x0F,0xF0,0x00,0x00,
        0x00,0x00,0x00,0x0F,0xFF,0x00,0x00,0x00,
        0x00,0x00,0x00,0xFF,0xF0,0x00,0x00,0x00,
        0x00,0x00,0x0F,0xF0,0x00,0x00,0x00,0x00,
        0x00,0x00,0x0F,0xFF,0xFF,0xF0,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },
    // Digit 3
    {
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,
        0x00,0x00,0x0F,0xF0,0x0F,0xF0,0x00,0x00,
        0x00,0x00,0x00,0x00,0x0F,0xF0,0x00,0x00,
        0x00,0x00,0x00,0x0F,0xFF,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x0F,0xF0,0x00,0x00,
        0x00,0x00,0x0F,0xF0,0x0F,0xF0,0x00,0x00,
        0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },
    // Digit 4
    {
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x0F,0xF0,0x0F,0xF0,0x00,0x00,
        0x00,0x00,0x0F,0xF0,0x0F,0xF0,0x00,0x00,
        0x00,0x00,0x0F,0xF0,0x0F,0xF0,0x00,0x00,
        0x00,0x00,0x0F,0xFF,0xFF,0xF0,0x00,0x00,
        0x00,0x00,0x00,0x00,0x0F,0xF0,0x00,0x00,
        0x00,0x00,0x00,0x00,0x0F,0xF0,0x00,0x00,
        0x00,0x00,0x00,0x00,0x0F,0xF0,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },
    // Digit 5
    {
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x0F,0xFF,0xFF,0xF0,0x00,0x00,
        0x00,0x00,0x0F,0xF0,0x00,0x00,0x00,0x00,
        0x00,0x00,0x0F,0xFF,0xFF,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x0F,0xF0,0x00,0x00,
        0x00,0x00,0x00,0x00,0x0F,0xF0,0x00,0x00,
        0x00,0x00,0x0F,0xF0,0x0F,0xF0,0x00,0x00,
        0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },
    // Digit 6
    {
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,
        0x00,0x00,0x0F,0xF0,0x00,0x00,0x00,0x00,
        0x00,0x00,0x0F,0xFF,0xFF,0x00,0x00,0x00,
        0x00,0x00,0x0F,0xF0,0x0F,0xF0,0x00,0x00,
        0x00,0x00,0x0F,0xF0,0x0F,0xF0,0x00,0x00,
        0x00,0x00,0x0F,0xF0,0x0F,0xF0,0x00,0x00,
        0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },
    // Digit 7
    {
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x0F,0xFF,0xFF,0xF0,0x00,0x00,
        0x00,0x00,0x00,0x00,0x0F,0xF0,0x00,0x00,
        0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,
        0x00,0x00,0x00,0x0F,0xF0,0x00,0x00,0x00,
        0x00,0x00,0x00,0x0F,0xF0,0x00,0x00,0x00,
        0x00,0x00,0x00,0x0F,0xF0,0x00,0x00,0x00,
        0x00,0x00,0x00,0x0F,0xF0,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },
    // Digit 8
    {
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,
        0x00,0x00,0x0F,0xF0,0x0F,0xF0,0x00,0x00,
        0x00,0x00,0x0F,0xF0,0x0F,0xF0,0x00,0x00,
        0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,
        0x00,0x00,0x0F,0xF0,0x0F,0xF0,0x00,0x00,
        0x00,0x00,0x0F,0xF0,0x0F,0xF0,0x00,0x00,
        0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    },
    // Digit 9
    {
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,
        0x00,0x00,0x0F,0xF0,0x0F,0xF0,0x00,0x00,
        0x00,0x00,0x0F,0xF0,0x0F,0xF0,0x00,0x00,
        0x00,0x00,0x00,0xFF,0xFF,0xF0,0x00,0x00,
        0x00,0x00,0x00,0x00,0x0F,0xF0,0x00,0x00,
        0x00,0x00,0x00,0x00,0x0F,0xF0,0x00,0x00,
        0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    }
};

// Write to Next register
static void nextreg_write(uint8_t reg, uint8_t val) {
    IO_NEXTREG_REG = reg;
    IO_NEXTREG_DAT = val;
}

// Read from Next register
static uint8_t nextreg_read(uint8_t reg) {
    IO_NEXTREG_REG = reg;
    return IO_NEXTREG_DAT;
}

// Initialize sprite system
void sprites_init(void) {
    // Enable sprites and set sprite priority over Layer 2
    nextreg_write(NEXTREG_SPRITE_SYSTEM, 0x03);  // Enable sprites, sprites over ULA

    // Upload sprite patterns
    sprites_upload_patterns();
}

// Upload sprite patterns to pattern memory
void sprites_upload_patterns(void) {
    uint16_t i;
    uint8_t d;

    // Select sprite pattern slot 0
    z80_outp(SPRITE_SLOT_PORT, SPRITE_PLAYER);

    // Upload player sprite
    for (i = 0; i < 256; i++) {
        z80_outp(SPRITE_PATTERN_PORT, sprite_player[i]);
    }

    // Upload bullet sprite (slot 1)
    for (i = 0; i < 256; i++) {
        z80_outp(SPRITE_PATTERN_PORT, sprite_bullet[i]);
    }

    // Upload enemy1 sprite (slot 2)
    for (i = 0; i < 256; i++) {
        z80_outp(SPRITE_PATTERN_PORT, sprite_enemy1[i]);
    }

    // Upload enemy2 sprite (slot 3)
    for (i = 0; i < 256; i++) {
        z80_outp(SPRITE_PATTERN_PORT, sprite_enemy2[i]);
    }

    // Upload explosion sprite (slot 4)
    for (i = 0; i < 256; i++) {
        z80_outp(SPRITE_PATTERN_PORT, sprite_explosion[i]);
    }

    // Upload life sprite (slot 5)
    for (i = 0; i < 256; i++) {
        z80_outp(SPRITE_PATTERN_PORT, sprite_life[i]);
    }

    // Upload digit sprites (slots 6-15 for digits 0-9)
    for (d = 0; d < 10; d++) {
        for (i = 0; i < 256; i++) {
            z80_outp(SPRITE_PATTERN_PORT, sprite_digits[d][i]);
        }
    }

    // Upload highway sprite (slot 16)
    for (i = 0; i < 256; i++) {
        z80_outp(SPRITE_PATTERN_PORT, sprite_highway[i]);
    }
}

// Set sprite attributes
void sprite_set(uint8_t slot, int16_t x, int16_t y, uint8_t pattern, uint8_t flags) {
    // Adjust coordinates for sprite offset (sprites are positioned from 32,32)
    x += 32;
    y += 32;

    // Select sprite attribute slot
    z80_outp(SPRITE_SLOT_PORT, slot);

    // Write attribute bytes
    z80_outp(SPRITE_ATTR_PORT, x & 0xFF);           // X low byte
    z80_outp(SPRITE_ATTR_PORT, y & 0xFF);           // Y low byte
    z80_outp(SPRITE_ATTR_PORT, (x >> 8) | flags);   // X MSB, palette offset, mirror, rotate
    z80_outp(SPRITE_ATTR_PORT, 0x80 | pattern);     // Visible + pattern
}

// Hide a sprite
void sprite_hide(uint8_t slot) {
    z80_outp(SPRITE_SLOT_PORT, slot);
    z80_outp(SPRITE_ATTR_PORT, 0);
    z80_outp(SPRITE_ATTR_PORT, 0);
    z80_outp(SPRITE_ATTR_PORT, 0);
    z80_outp(SPRITE_ATTR_PORT, 0);  // Invisible (bit 7 = 0)
}

// Layer 2 functions
// Enable Layer 2 and map it for writing
static void layer2_enable(void) {
    nextreg_write(NEXTREG_LAYER2_CTRL, 0x00);
    z80_outp(LAYER2_ACCESS_PORT, 0x03);  // Enable Layer 2 + write enable
}

// Clear Layer 2 with a color
void layer2_clear(uint8_t color) {
    uint8_t bank;
    uint16_t i;
    uint8_t *ptr;

    // Layer 2 is in banks 8, 9, 10 (256x192 @ 8bpp = 48KB)
    for (bank = 0; bank < 3; bank++) {
        // Map Layer 2 bank to slot 2 (0x4000-0x7FFF)
        z80_outp(LAYER2_ACCESS_PORT, 0x03 | (bank << 6));

        ptr = (uint8_t *)0x4000;
        for (i = 0; i < 16384; i++) {
            *ptr++ = color;
        }
    }

    // Reset to normal operation
    z80_outp(LAYER2_ACCESS_PORT, 0x02);
}

// Plot a pixel on Layer 2
void layer2_plot(uint8_t x, uint8_t y, uint8_t color) {
    uint8_t bank;
    uint8_t *ptr;

    if (y >= 192) return;

    // Determine which bank (each bank = 64 lines)
    bank = y / 64;

    // Map the appropriate Layer 2 bank
    z80_outp(LAYER2_ACCESS_PORT, 0x03 | (bank << 6));

    // Calculate address within the bank
    ptr = (uint8_t *)0x4000 + ((y % 64) * 256) + x;
    *ptr = color;
}

// Draw horizontal line
void layer2_hline(uint8_t x1, uint8_t x2, uint8_t y, uint8_t color) {
    uint8_t x;
    for (x = x1; x <= x2; x++) {
        layer2_plot(x, y, color);
    }
}

// Draw vertical line
void layer2_vline(uint8_t x, uint8_t y1, uint8_t y2, uint8_t color) {
    uint8_t y;
    for (y = y1; y <= y2; y++) {
        layer2_plot(x, y, color);
    }
}

// Fill rectangle
void layer2_fill_rect(uint8_t x, uint8_t y, uint8_t w, uint8_t h, uint8_t color) {
    uint8_t i, j;
    for (j = 0; j < h; j++) {
        for (i = 0; i < w; i++) {
            layer2_plot(x + i, y + j, color);
        }
    }
}
